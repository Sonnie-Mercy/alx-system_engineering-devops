#!/usr/bin/env bash
# A bash script configuring nginx

# Install Nginx
sudo apt-get update
sudo apt-get install -y nginx

# Configure Nginx to listen on port 80
sudo sed -i 's/listen\s*80;/listen 80 default_server;/g' /etc/nginx/sites-available/default

# Create index.html file with redirection message and redirect URL
echo '<html><head><title>Redirecting...</title></head><body><h1>301 Moved Permanently</h1><p>The document has moved <a href="https://www.example.com">here</a>.</p></body></html>' | sudo tee /var/www/html/redirect.html

# Configure Nginx to redirect /redirect_me to /redirect.html with a 301 status code
sudo bash -c 'echo "server {
    listen 80 default_server;
    listen [::]:80 default_server;

    server_name _;

    location /redirect_me {
        return 301 https://$server_name/redirect.html;
    }

    location / {
        root /var/www/html;
        index index.html index.htm;
    }
}" > /etc/nginx/sites-available/default'

# Restart Nginx
sudo service nginx restart

# Test Nginx configuration by sending a GET request to the server and checking for a "301 Moved Permanently" status code
response=$(curl -s -I http://localhost/redirect_me)
if [[ $response == *"301 Moved Permanently"* ]]; then
  echo "Nginx is working properly with redirection."
else
  echo "Nginx is not working properly with redirection."
fi
